---
title: "Actual Branch Length Analysis"
output: 
  prettydoc::html_pretty:
    theme: "cayman"
params: 
  mini: TRUE
  mini_n: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, include = TRUE)
library(tidyverse)
library(broom)
source("utils.R")
path_to_data <- "./" 
```

## Goal
The primary goal of this analysis is to determine if the literal branch length estimates themselves differ across protein models. 
<br>
First, let's read in the datasets and create smaller versions of them that are easier to work with, just like last time.

```{r read in the data and make smaller datasets, message=FALSE}

birds_file <- file.path(path_to_data, "bird_empirical_branch_lengths.csv")
mammals_file <- file.path(path_to_data, "mammal_empirical_branch_lengths.csv")
enzymes_file <- file.path(path_to_data, "enzyme_empirical_branch_lengths.csv")


birds   <- read_csv(birds_file) %>% mutate(dataset =  "birds", id = as.character(id)) #might as well mutate here so we can bind rows later 
mammals <- read_csv(mammals_file) %>% mutate(dataset =  "mammals", id = as.character(id))
enzymes <- read_csv(enzymes_file) %>% mutate(dataset =  "enzymes", id = as.character(id))

# Downsample for mini analysis only
minify <- function(df) 
{
  df %>%
    group_by(id) %>% 
    nest() %>% #condense each id into its own tibble-like thing 
    ungroup() %>%
    slice(1:params$mini_n) %>% #this takes the first *however many* rows from the dataset. The *however many* is specified by the params$mini_n
    unnest(cols = c(data))
}

if (params$mini == TRUE) #if we want to use the mini versions of the datasets, then use the mini function on each of them!!
{
  minify(birds) -> birds 
  minify(enzymes) -> enzymes
  minify(mammals) -> mammals
}


bind_rows(mammals, enzymes, birds) -> full_data #this is just one big data frame consisting of the three datasets


```

## The enzyme, mammal, and enzyme data all together

```{r show_bl, echo=TRUE}
print(full_data) 
```


## The data pivoted wide to show all models' branch lengths and pivoted again to compare Poisson branch lengths with all others 
```{r, pivot full data, echo=TRUE}
  
full_data %>%
  unite(combined_model, model, ASRV) %>%
  group_by(id, dataset) %>%
  pivot_wider(names_from = combined_model, 
              values_from = branch_length) %>%
  ungroup() -> input_data

input_data%>%
pivot_longer( -c(id, node, dataset, Poisson_FALSE), names_to = "model_type", values_to = "branchlength")->input_poisson_f

```



```{r,show input data}
print(input_data)
print(input_poisson_f)
```


## Perform a lm of Poisson_FALSE~branchlength, with the help of nest() and broom().
```{r, pivot full data and use lm, echo=TRUE}

input_poisson_f%>%
  select(-node) %>%
  group_by(id, dataset, model_type)%>%
  tidyr::nest()%>%
  mutate(lm_fit=map(data, ~lm(Poisson_FALSE~branchlength, data=.)))->nested


nested%>%
  select(-data)%>%
  mutate(tidied=map(lm_fit, broom::tidy))%>%
  unnest(cols = c(tidied))->unnested

unnested%>%
  filter(term == "(Intercept)")%>%
  select(id, dataset, model_type, estimate)->Intercepts_df

Intercepts_df
 

```


```{r, ggplot the Intercepts}


