---
title: "Branch length summary stats analysis"
output: 
  prettydoc::html_pretty:
    theme: "cayman"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo= TRUE, include = TRUE)
library(tidyverse)
source("utils.R")
path_to_data <- "./"
```

## Goal
The primary goal of this analysis is to determine whether branch length summary statistics differ across protein models. This will be done mainly with code that visualizes these statistics. 

```{r read in the data, message=FALSE}


birds_file <- file.path(path_to_data, "bird_empirical_branch_lengths.csv")
mammals_file <- file.path(path_to_data, "mammal_empirical_branch_lengths.csv")
enzymes_file <- file.path(path_to_data, "enzyme_empirical_branch_lengths.csv")

mammals <- read_csv(mammals_file) %>% mutate(type = "mammals")
enzymes <- read_csv(enzymes_file) %>% mutate(type = "enzymes")
birds   <- read_csv(birds_file) %>% mutate(type = "birds")

birds$id=as.character(birds$id)
mega_empirical_dataset<-bind_rows(enzymes, mammals, birds)

```

### First Step: Create Smaller Datasets
The datasets are too large, so let's make smaller datasets comprised of three of each id from each dataset
```{r make mini datasets to work with}

mammal_ids <- c("ENSG00000000003_AA","ENSG00000000005_AA", "ENSG00000000457_AA")
mammals%>%
  filter(id %in% mammal_ids)->mammals_3_id

birds%>%
  filter(id%in%c("100", "1000", "10003"))->birds_3_id

enzymes%>%
  filter(id%in%c("13PK_A", "1A16_A", "1CL1_A"))->enzymes_3_id

```

## Analysis of Branchlength Differences Between Models 
Okay, now that we have our fun mini-datasets, let's begin to see how the branch length estimates look!

```{r summarize branch lengths, include=FALSE}
summarize_branch_lengths(mammals_3_id)->mammals_3_bl
summarize_branch_lengths(enzymes_3_id)->enzymes_3_bl
summarize_branch_lengths(birds_3_id)->birds_3_bl

mega_mini_bl<-bind_rows(mammals_3_bl,enzymes_3_bl,birds_3_bl)

mega_mini_bl%>%
  mutate(dataset= case_when(id %in% mammal_ids ~"mammals",
                            id %in% c("1CL1_A", "1A16_A", "13PK_A") ~"enzymes",
                            id %in% c("1000","100", "10003") ~"birds"))-> mega_mini_bl2
   

```


```{r define function for bl measurements, include=FALSE}

Violin_bl_measurements<-function(bl_df, measurement, y_axis_title, plot_title)
{
bl_df%>%
  select({{measurement}}, model, id, ASRV, dataset)%>%
  filter(ASRV==TRUE)%>%
  group_by(model, id, dataset)%>%
  ggplot(aes(x=model, y={{measurement}}, fill=model))+
  geom_violin()+
  geom_point()+
  stat_summary()+
  scale_fill_brewer(palette = "Dark2")+
  labs(x="Model", y=y_axis_title, title=plot_title)
}

```

```{r vizualize branch lengths}


Violin_bl_measurements(mega_mini_bl2, treelength, "Treelength", "Estimated Treelengths for Selected Id's")
Violin_bl_measurements(mega_mini_bl2, mean_bl, "Mean_bl", "Estimated Mean Branchlengths for Selected Id's")
Violin_bl_measurements(mega_mini_bl2, max_bl, "Max_bl", "Estimated Maximum Branchlengths for Selected Id's")

```
<br><br>
From this, we see that FLU appears to overestimate the branchlength-related measurements while Poisson underestimates!
<br><br>

### Now, Let's address our goal by utilizing linear models to determine if branch length summary statistics do indeed differ across protein models.

```{r, linear model statistic~ protein_model + ASRV+ dataset}
linear_model_function_curlies<-function(input_branchlength_df, dependent_variable_column)
{
  input_branchlength_df %>%
    mutate(ASRV_modified= if_else(ASRV==TRUE, "Yes", "No")) -> df_for_modeling #need to make ASRV non-boolean
  
  lm({{dependent_variable_column}} ~ model+ dataset+ ASRV_modified, data= df_for_modeling) %>% #since we are referring to a column,we need to use curlies
    aov() %>%
    TukeyHSD()->fitted_model
  
  fitted_model$model %>% 
    as_tibble(rownames = "Compare") #this will make the output a little nicer
}
  
linear_model_function_curlies(mega_mini_bl2, mega_mini_bl2$mean_bl)
linear_model_function_curlies(mega_mini_bl2, mega_mini_bl2$treelength)
linear_model_function_curlies(mega_mini_bl2, mega_mini_bl2$max_bl)
```
<br><br>
From this, the only significant difference that we find between the models' estimates of these summary statistics is between the treelength estimates of Poisson and FLU (p=0.0104). This makes sense when going back to the violin plots above, where the difference in treelength estimates between Poisson and FLU can be visualized!
<br><br>

### Analysis of Datasets
Thus far, we have really only focused on the differences that exist in branchlength estimates between models, but what differences exist between the datasets themselves?

```{r, vizualize differnces in datasets}

mega_mini_bl2%>%
  select(dataset, treelength, mean_bl, max_bl)%>%
  group_by(dataset)%>%
summarize(avg_treelength=mean(treelength), avg_bl=mean(mean_bl), avg_max_bl=mean(max_bl))





mega_mini_bl2%>%
  select(dataset, treelength, mean_bl, max_bl)%>%
  group_by(dataset)%>%
summarize(avg_treelength=mean(treelength), avg_bl=mean(mean_bl), avg_max_bl=mean(max_bl))%>%
  ggplot(aes(x=dataset, y=avg_max_bl, fill=dataset))+
  geom_col()+
theme_classic()+
  labs(title="Differences in Branchlength Estimates Between Datasets", x="Dataset", y="Average Max Branchlength")+
  scale_fill_brewer(palette = "Dark2")

```
<br><br>
This quick analysis shows us that the enzymes dataset displays MUCH MORE evolutionary change than the other two datasets (at least for the three id's selected for the mini-versions being utilized). 

### Now, let's shift gears a little and investigate branchlength differences between models with 
